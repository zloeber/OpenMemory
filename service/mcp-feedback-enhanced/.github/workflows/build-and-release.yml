name: Build Desktop & Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (ignored if custom_version is provided)'
        required: false
        default: 'patch'
        type: choice
        options:
        - patch    # 2.0.0 -> 2.0.1 (bug fixes, security patches, documentation updates)
        - minor    # 2.0.0 -> 2.1.0 (new features, enhancements, backward-compatible changes)
        - major    # 2.0.0 -> 3.0.0 (breaking changes, architecture refactoring, API changes)
      custom_version:
        description: 'Custom version number (e.g., 2.5.0) - overrides version_type if provided'
        required: false
        type: string
      platforms:
        description: 'é¸æ“‡è¦æ§‹å»ºçš„å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - macos
        - linux
      skip_release:
        description: 'åªæ§‹å»ºæ¡Œé¢æ‡‰ç”¨ï¼Œä¸é€²è¡Œç™¼ä½ˆ'
        required: false
        default: false
        type: boolean

jobs:
  # ç¬¬ä¸€æ­¥ï¼šæ§‹å»ºæ¡Œé¢æ‡‰ç”¨
  build-desktop:
    name: Build Desktop Applications
    uses: ./.github/workflows/build-desktop.yml
    with:
      platforms: ${{ github.event.inputs.platforms }}
      upload_artifacts: true

  # ç¬¬äºŒæ­¥ï¼šç­‰å¾…æ§‹å»ºå®Œæˆä¸¦æª¢æŸ¥çµæžœ
  check-build:
    name: Check Build Results
    needs: build-desktop
    runs-on: ubuntu-latest
    outputs:
      can_release: ${{ steps.check.outputs.can_release }}
      build_run_id: ${{ steps.check.outputs.build_run_id }}

    steps:
    - name: Check build results
      id: check
      run: |
        echo "ðŸ” æª¢æŸ¥æ¡Œé¢æ‡‰ç”¨æ§‹å»ºçµæžœ..."

        # æª¢æŸ¥æ§‹å»ºæ˜¯å¦æˆåŠŸ
        if [ "${{ needs.build-desktop.result }}" = "success" ]; then
          echo "âœ… æ¡Œé¢æ‡‰ç”¨æ§‹å»ºæˆåŠŸ"
          echo "can_release=true" >> $GITHUB_OUTPUT
          echo "build_run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ¡Œé¢æ‡‰ç”¨æ§‹å»ºå¤±æ•—"
          echo "can_release=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Generate summary
      run: |
        echo "## ðŸ–¥ï¸ æ¡Œé¢æ‡‰ç”¨æ§‹å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… æ§‹å»ºçµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‹€æ…‹**: æˆåŠŸ âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: ${{ github.event.inputs.platforms }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ github.event.inputs.skip_release }}" = "true" ]; then
          echo "### â­ï¸ è·³éŽç™¼ä½ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ ¹æ“šè¨­ç½®ï¼Œå·²è·³éŽè‡ªå‹•ç™¼ä½ˆã€‚" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚éœ€ç™¼ä½ˆï¼Œè«‹æ‰‹å‹•é‹è¡Œ [Auto Release to PyPI](../../actions/workflows/publish.yml) å·¥ä½œæµç¨‹ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸš€ æº–å‚™ç™¼ä½ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ¡Œé¢æ‡‰ç”¨æ§‹å»ºæˆåŠŸï¼Œæ­£åœ¨æº–å‚™è‡ªå‹•ç™¼ä½ˆ..." >> $GITHUB_STEP_SUMMARY
        fi

  # ç¬¬ä¸‰æ­¥ï¼šè‡ªå‹•ç™¼ä½ˆï¼ˆå¦‚æžœæ²’æœ‰è·³éŽï¼‰
  release:
    name: Auto Release to PyPI
    needs: [build-desktop, check-build]
    if: ${{ needs.check-build.outputs.can_release == 'true' && github.event.inputs.skip_release != 'true' }}
    uses: ./.github/workflows/publish.yml
    with:
      version_type: ${{ github.event.inputs.version_type }}
      custom_version: ${{ github.event.inputs.custom_version }}
      include_desktop: true
      desktop_build_run_id: ${{ needs.check-build.outputs.build_run_id }}
    secrets: inherit

  # æœ€çµ‚æ‘˜è¦
  summary:
    name: Workflow Summary
    needs: [build-desktop, check-build, release]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Generate final summary
      run: |
        echo "## ðŸŽ¯ æ§‹å»ºå’Œç™¼ä½ˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ¡Œé¢æ§‹å»ºç‹€æ…‹
        echo "### ðŸ–¥ï¸ æ¡Œé¢æ‡‰ç”¨æ§‹å»º" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.build-desktop.result }}" = "success" ]; then
          echo "- âœ… **æˆåŠŸ** - æ‰€æœ‰é¸å®šå¹³å°æ§‹å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **å¤±æ•—** - æ§‹å»ºéŽç¨‹ä¸­å‡ºç¾éŒ¯èª¤" >> $GITHUB_STEP_SUMMARY
        fi

        # ç™¼ä½ˆç‹€æ…‹
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ç™¼ä½ˆç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.skip_release }}" = "true" ]; then
          echo "- â­ï¸ **å·²è·³éŽ** - æ ¹æ“šç”¨æˆ¶è¨­ç½®è·³éŽç™¼ä½ˆ" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.release.result }}" = "success" ]; then
          echo "- âœ… **æˆåŠŸ** - å·²ç™¼ä½ˆåˆ° PyPI å’Œ GitHub Releases" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.release.result }}" = "failure" ]; then
          echo "- âŒ **å¤±æ•—** - ç™¼ä½ˆéŽç¨‹ä¸­å‡ºç¾éŒ¯èª¤" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.release.result }}" = "skipped" ]; then
          echo "- â­ï¸ **å·²è·³éŽ** - ç”±æ–¼æ¡Œé¢æ§‹å»ºå¤±æ•—è€Œè·³éŽ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â³ **é€²è¡Œä¸­** - ç™¼ä½ˆæ­£åœ¨é€²è¡Œä¸­" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— ç›¸é—œéˆæŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æ¡Œé¢æ§‹å»ºå·¥ä½œæµç¨‹](../../actions/workflows/build-desktop.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- [ç™¼ä½ˆå·¥ä½œæµç¨‹](../../actions/workflows/publish.yml)" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.release.result }}" = "success" ]; then
          echo "- [PyPI é é¢](https://pypi.org/project/mcp-feedback-enhanced/)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Releases](../../releases)" >> $GITHUB_STEP_SUMMARY
        fi
