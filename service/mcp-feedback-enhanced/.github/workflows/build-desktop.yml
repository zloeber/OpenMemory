name: Build Desktop Applications

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
    inputs:
      platforms:
        description: 'é¸æ“‡è¦æ§‹å»ºçš„å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - macos
        - linux
      upload_artifacts:
        description: 'æ˜¯å¦ä¸Šå‚³æ§‹å»ºç”¢ç‰©'
        required: true
        default: true
        type: boolean

  push:
    paths:
      - 'src-tauri/**'  # æ¡Œé¢æ‡‰ç”¨ä»£ç¢¼è®Šæ›´æ™‚è‡ªå‹•è§¸ç™¼
      - 'scripts/build_desktop.py'
    branches:
      - main

  pull_request:
    paths:
      - 'src-tauri/**'
      - 'scripts/build_desktop.py'

env:
  CARGO_TERM_COLOR: always

jobs:
  # å¤šå¹³å°æ¡Œé¢æ‡‰ç”¨æ§‹å»º
  build-desktop:
    strategy:
      fail-fast: false  # å…è¨±éƒ¨åˆ†å¹³å°å¤±æ•—
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: mcp-feedback-enhanced-desktop.exe
            name: windows
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: mcp-feedback-enhanced-desktop
            name: macos-intel
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: mcp-feedback-enhanced-desktop
            name: macos-arm64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: mcp-feedback-enhanced-desktop
            name: linux

    runs-on: ${{ matrix.os }}

    steps:
    - name: Check if platform should be built
      id: check_platform
      shell: bash
      run: |
        SHOULD_BUILD="false"
        PLATFORM_INPUT="${{ github.event.inputs.platforms }}"
        MATRIX_NAME="${{ matrix.name }}"

        # æª¢æŸ¥æ˜¯å¦æ‡‰è©²æ§‹å»ºæ­¤å¹³å°
        if [ "$PLATFORM_INPUT" = "all" ] || [ "$PLATFORM_INPUT" = "" ]; then
          SHOULD_BUILD="true"
        elif [ "$PLATFORM_INPUT" = "windows" ] && [ "$MATRIX_NAME" = "windows" ]; then
          SHOULD_BUILD="true"
        elif [ "$PLATFORM_INPUT" = "macos" ] && ([ "$MATRIX_NAME" = "macos-intel" ] || [ "$MATRIX_NAME" = "macos-arm64" ]); then
          SHOULD_BUILD="true"
        elif [ "$PLATFORM_INPUT" = "linux" ] && [ "$MATRIX_NAME" = "linux" ]; then
          SHOULD_BUILD="true"
        fi

        echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
        echo "Platform: $MATRIX_NAME, Input: $PLATFORM_INPUT, Should build: $SHOULD_BUILD"

    - name: Checkout code
      if: steps.check_platform.outputs.should_build == 'true'
      uses: actions/checkout@v4

    - name: Install Rust
      if: steps.check_platform.outputs.should_build == 'true'
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install uv
      if: steps.check_platform.outputs.should_build == 'true'
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      if: steps.check_platform.outputs.should_build == 'true'
      run: uv python install

    - name: Install dependencies
      if: steps.check_platform.outputs.should_build == 'true'
      run: uv sync --dev

    - name: Cache Rust dependencies
      if: steps.check_platform.outputs.should_build == 'true'
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-

    - name: Install platform-specific dependencies (Linux)
      if: ${{ steps.check_platform.outputs.should_build == 'true' && matrix.os == 'ubuntu-latest' }}
      run: |
        sudo apt-get update
        # å®‰è£åŸºæœ¬ä¾è³´
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          librsvg2-dev \
          patchelf \
          libgtk-3-dev

        # å˜—è©¦å®‰è£ ayatana-appindicatorï¼Œå¦‚æœå¤±æ•—å‰‡ä½¿ç”¨å‚³çµ±çš„ appindicator
        if ! sudo apt-get install -y libayatana-appindicator3-dev; then
          echo "âš ï¸ libayatana-appindicator3-dev å®‰è£å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ libappindicator3-dev"
          sudo apt-get install -y libappindicator3-dev
        fi

    - name: Build desktop application for ${{ matrix.name }}
      if: steps.check_platform.outputs.should_build == 'true'
      run: |
        cd src-tauri
        echo "ğŸ”¨ é–‹å§‹æ§‹å»º ${{ matrix.name }} (${{ matrix.target }})..."
        cargo build --release --target ${{ matrix.target }} --bin mcp-feedback-enhanced-desktop
        echo "âœ… æ§‹å»ºå®Œæˆ"

    - name: Verify build output
      if: steps.check_platform.outputs.should_build == 'true'
      run: |
        echo "ğŸ” æª¢æŸ¥æ§‹å»ºç”¢ç‰©..."
        BINARY_PATH="src-tauri/target/${{ matrix.target }}/release/${{ matrix.binary }}"

        if [ -f "$BINARY_PATH" ]; then
          echo "âœ… æ‰¾åˆ°äºŒé€²åˆ¶æ–‡ä»¶: $BINARY_PATH"
          ls -la "$BINARY_PATH"

          # æª¢æŸ¥æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -f%z "$BINARY_PATH" 2>/dev/null || stat -c%s "$BINARY_PATH" 2>/dev/null || echo "unknown")
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $FILE_SIZE bytes"

          # æª¢æŸ¥æ–‡ä»¶é¡å‹ (åƒ…åœ¨ Linux/macOS)
          if [ "${{ matrix.os }}" != "windows-latest" ]; then
            file "$BINARY_PATH" || echo "ç„¡æ³•æª¢æŸ¥æ–‡ä»¶é¡å‹"
          fi
        else
          echo "âŒ ${{ matrix.name }} äºŒé€²åˆ¶æ–‡ä»¶ä¸å­˜åœ¨: $BINARY_PATH"
          echo "ğŸ” æª¢æŸ¥ç›®æ¨™ç›®éŒ„å…§å®¹:"
          ls -la "src-tauri/target/${{ matrix.target }}/release/" || echo "ç›®æ¨™ç›®éŒ„ä¸å­˜åœ¨"
          exit 1
        fi
      shell: bash

    - name: Upload desktop binary
      if: ${{ steps.check_platform.outputs.should_build == 'true' && github.event.inputs.upload_artifacts != 'false' }}
      uses: actions/upload-artifact@v4
      with:
        name: desktop-${{ matrix.name }}
        path: src-tauri/target/${{ matrix.target }}/release/${{ matrix.binary }}
        retention-days: 30  # ä¿ç•™ 30 å¤©
        compression-level: 6
        if-no-files-found: error  # å¦‚æœæ²’æœ‰æ‰¾åˆ°æ–‡ä»¶å‰‡å¤±æ•—

  # æ§‹å»ºæ‘˜è¦å’Œé©—è­‰
  build-summary:
    needs: build-desktop
    runs-on: ubuntu-latest
    if: always()
    outputs:
      build_success: ${{ steps.check_results.outputs.success }}
      platforms_built: ${{ steps.check_results.outputs.platforms }}

    steps:
    - name: Check build results
      id: check_results
      run: |
        echo "ğŸ” æª¢æŸ¥æ§‹å»ºçµæœ..."

        # æª¢æŸ¥æ§‹å»ºç‹€æ…‹
        BUILD_SUCCESS="false"
        PLATFORMS_BUILT=""

        if [ "${{ needs.build-desktop.result }}" = "success" ]; then
          BUILD_SUCCESS="true"
          PLATFORMS_BUILT="windows,macos-intel,macos-arm64,linux"
          echo "âœ… æ‰€æœ‰å¹³å°æ§‹å»ºæˆåŠŸ"
        else
          echo "âŒ æ§‹å»ºå¤±æ•—æˆ–éƒ¨åˆ†å¤±æ•—"
        fi

        echo "success=$BUILD_SUCCESS" >> $GITHUB_OUTPUT
        echo "platforms=$PLATFORMS_BUILT" >> $GITHUB_OUTPUT

    - name: Generate build summary
      run: |
        echo "## ğŸ–¥ï¸ æ¡Œé¢æ‡‰ç”¨æ§‹å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ§‹å»ºçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æª¢æŸ¥å„å¹³å°æ§‹å»ºç‹€æ…‹
        if [ "${{ needs.build-desktop.result }}" = "success" ]; then
          echo "âœ… **æ‰€æœ‰å¹³å°æ§‹å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | ç‹€æ…‹ | ç”¢ç‰©åç¨± |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x64 | âœ… æˆåŠŸ | \`desktop-windows\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Intel | âœ… æˆåŠŸ | \`desktop-macos-intel\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 | âœ… æˆåŠŸ | \`desktop-macos-arm64\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x64 | âœ… æˆåŠŸ | \`desktop-linux\` |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-desktop.result }}" = "failure" ]; then
          echo "âŒ **éƒ¨åˆ†å¹³å°æ§‹å»ºå¤±æ•—**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è«‹æª¢æŸ¥å„å¹³å°çš„æ§‹å»ºæ—¥èªŒä»¥äº†è§£å¤±æ•—åŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **æ§‹å»ºç‹€æ…‹**: ${{ needs.build-desktop.result }}" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ ç”¢ç‰©ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¿ç•™æœŸé™**: 30 å¤©" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¸‹è¼‰ä½ç½®**: GitHub Actions Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **ä½¿ç”¨æ–¹å¼**: åœ¨ç™¼ä½ˆå·¥ä½œæµç¨‹ä¸­è‡ªå‹•ä¸‹è¼‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.build-desktop.result }}" = "success" ]; then
          echo "âœ… **å¯ä»¥é€²è¡Œç™¼ä½ˆ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. å‰å¾€ [Auto Release to PyPI](../../actions/workflows/publish.yml)" >> $GITHUB_STEP_SUMMARY
          echo "2. é»æ“Š 'Run workflow'" >> $GITHUB_STEP_SUMMARY
          echo "3. è¨­ç½® 'include_desktop' ç‚º true" >> $GITHUB_STEP_SUMMARY
          echo "4. å¯é¸ï¼šæŒ‡å®šæ­¤æ¬¡æ§‹å»ºçš„ Run ID: \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **è«‹ä¿®å¾©æ§‹å»ºå•é¡Œå¾Œé‡æ–°é‹è¡Œ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æª¢æŸ¥æ§‹å»ºæ—¥èªŒä¸­çš„éŒ¯èª¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- ä¿®å¾©å•é¡Œå¾Œé‡æ–°è§¸ç™¼æ­¤å·¥ä½œæµç¨‹" >> $GITHUB_STEP_SUMMARY
          echo "- ç¢ºä¿æ‰€æœ‰å¹³å°éƒ½èƒ½æˆåŠŸæ§‹å»ºå¾Œå†é€²è¡Œç™¼ä½ˆ" >> $GITHUB_STEP_SUMMARY
        fi

  # æ–°å¢ï¼šå°‡æ§‹å»ºçš„äºŒé€²åˆ¶æ–‡ä»¶æäº¤åˆ° Git
  commit-binaries:
    name: æäº¤æ¡Œé¢äºŒé€²åˆ¶æ–‡ä»¶åˆ° Git
    runs-on: ubuntu-latest
    needs: [build-desktop, build-summary]
    if: needs.build-desktop.result == 'success'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Download all desktop artifacts
      uses: actions/download-artifact@v4
      with:
        path: desktop-artifacts

    - name: Prepare desktop binaries for commit
      run: |
        echo "ğŸ“¦ æº–å‚™æ¡Œé¢äºŒé€²åˆ¶æ–‡ä»¶ä»¥æäº¤åˆ° Git..."

        # å‰µå»ºæ¡Œé¢æ‡‰ç”¨ç›®éŒ„
        mkdir -p src/mcp_feedback_enhanced/desktop_release

        # ç¢ºä¿ __init__.py å­˜åœ¨
        if [ ! -f "src/mcp_feedback_enhanced/desktop_release/__init__.py" ]; then
          echo '"""æ¡Œé¢æ‡‰ç”¨ç¨‹å¼äºŒé€²åˆ¶æª”æ¡ˆ"""' > src/mcp_feedback_enhanced/desktop_release/__init__.py
        fi

        # å®šç¾©å¹³å°æ˜ å°„
        declare -A PLATFORM_MAP=(
          ["desktop-windows"]="mcp-feedback-enhanced-desktop.exe"
          ["desktop-macos-intel"]="mcp-feedback-enhanced-desktop-macos-intel"
          ["desktop-macos-arm64"]="mcp-feedback-enhanced-desktop-macos-arm64"
          ["desktop-linux"]="mcp-feedback-enhanced-desktop-linux"
        )

        # è¤‡è£½ä¸¦é‡å‘½åäºŒé€²åˆ¶æ–‡ä»¶
        COPIED_COUNT=0

        for platform_dir in desktop-windows desktop-macos-intel desktop-macos-arm64 desktop-linux; do
          echo "ğŸ” è™•ç†å¹³å°: $platform_dir"

          # æŸ¥æ‰¾è©²å¹³å°çš„äºŒé€²åˆ¶æ–‡ä»¶
          BINARY_FILE=""
          if [ -d "desktop-artifacts/$platform_dir" ]; then
            BINARY_FILE=$(find "desktop-artifacts/$platform_dir" -name "mcp-feedback-enhanced-desktop*" -type f | head -1)
          fi

          if [ -n "$BINARY_FILE" ] && [ -f "$BINARY_FILE" ]; then
            TARGET_NAME="${PLATFORM_MAP[$platform_dir]}"
            cp "$BINARY_FILE" "src/mcp_feedback_enhanced/desktop_release/$TARGET_NAME"

            # è¨­ç½®åŸ·è¡Œæ¬Šé™ï¼ˆé Windowsï¼‰
            if [[ "$TARGET_NAME" != *.exe ]]; then
              chmod +x "src/mcp_feedback_enhanced/desktop_release/$TARGET_NAME"
            fi

            echo "âœ… $platform_dir: $BINARY_FILE -> $TARGET_NAME"
            COPIED_COUNT=$((COPIED_COUNT + 1))
          else
            echo "âš ï¸ $platform_dir: æœªæ‰¾åˆ°äºŒé€²åˆ¶æ–‡ä»¶"
          fi
        done

        echo ""
        echo "ğŸ“Š è¤‡è£½çµæœçµ±è¨ˆï¼š"
        echo "  æˆåŠŸè¤‡è£½: $COPIED_COUNT/4 å€‹å¹³å°"

        # é¡¯ç¤ºæœ€çµ‚æ–‡ä»¶åˆ—è¡¨
        echo ""
        echo "ğŸ“¦ æœ€çµ‚çš„æ¡Œé¢æ‡‰ç”¨äºŒé€²åˆ¶æ–‡ä»¶ï¼š"
        ls -la src/mcp_feedback_enhanced/desktop_release/

    - name: Commit desktop binaries
      run: |
        echo "ğŸ“ æäº¤æ¡Œé¢äºŒé€²åˆ¶æ–‡ä»¶åˆ° Git..."

        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if [ -n "$(git status --porcelain src/mcp_feedback_enhanced/desktop_release/)" ]; then
          # æ·»åŠ æ¡Œé¢äºŒé€²åˆ¶æ–‡ä»¶
          git add src/mcp_feedback_enhanced/desktop_release/

          # æäº¤è®Šæ›´
          git commit -m "ğŸ–¥ï¸ æ›´æ–°æ¡Œé¢æ‡‰ç”¨äºŒé€²åˆ¶æ–‡ä»¶ - è‡ªå‹•æ§‹å»ºå¤šå¹³å°ç‰ˆæœ¬ (Run ${{ github.run_id }})"

          # æ¨é€åˆ°é ç¨‹å€‰åº«
          git push origin main

          echo "âœ… æ¡Œé¢äºŒé€²åˆ¶æ–‡ä»¶å·²æˆåŠŸæäº¤ä¸¦æ¨é€åˆ° Git"
        else
          echo "â„¹ï¸ æ²’æœ‰æª¢æ¸¬åˆ°æ¡Œé¢äºŒé€²åˆ¶æ–‡ä»¶çš„è®Šæ›´ï¼Œè·³éæäº¤"
        fi
